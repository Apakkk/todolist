# SonarQube Setup Guide

This document explains how to set up SonarQube code quality analysis for this project.

## Overview

SonarQube is currently configured as an **optional** CI/CD step. The analysis job will only run if SonarQube secrets are configured in GitHub repository settings.

## Current Status

⚠️ **SonarQube Integration: Disabled**

The GitHub Actions workflow will skip the SonarQube analysis job because the required secrets are not configured.

## Prerequisites

You need one of the following:

1. **SonarCloud** (Free for open source projects)
   - Website: https://sonarcloud.io
   - Best for: Public repositories

2. **Self-hosted SonarQube** (Community Edition is free)
   - Website: https://www.sonarsource.com/products/sonarqube/downloads/
   - Best for: Private projects or on-premise requirements

3. **SonarQube Cloud** (Paid service)
   - Managed SonarQube instance

## Setup Instructions

### Option 1: SonarCloud (Recommended for Open Source)

1. **Create SonarCloud Account**
   ```bash
   # Visit: https://sonarcloud.io
   # Sign in with GitHub account
   ```

2. **Create New Project**
   - Click "+" → "Analyze new project"
   - Select your repository: `todolist`
   - Choose organization

3. **Generate Token**
   - Go to: My Account → Security → Generate Tokens
   - Name: `github-actions`
   - Type: `Project Analysis Token`
   - Copy the generated token

4. **Configure GitHub Secrets**
   ```bash
   # Go to: GitHub Repository → Settings → Secrets and variables → Actions
   
   # Add these secrets:
   SONAR_TOKEN=<your-sonarcloud-token>
   SONAR_HOST_URL=https://sonarcloud.io
   ```

5. **Update sonar-project.properties**
   ```properties
   # Add to sonar-project.properties:
   sonar.organization=<your-sonarcloud-organization>
   sonar.host.url=https://sonarcloud.io
   ```

### Option 2: Self-Hosted SonarQube

1. **Run SonarQube with Docker**
   ```bash
   docker run -d --name sonarqube \
     -p 9000:9000 \
     -v sonarqube_data:/opt/sonarqube/data \
     -v sonarqube_logs:/opt/sonarqube/logs \
     -v sonarqube_extensions:/opt/sonarqube/extensions \
     sonarqube:lts-community
   ```

2. **Access SonarQube**
   ```bash
   # Open browser: http://localhost:9000
   # Default credentials:
   # Username: admin
   # Password: admin
   # (You'll be prompted to change password)
   ```

3. **Create Project**
   - Click "Create Project" → "Manually"
   - Project key: `todolist-app`
   - Display name: `TodoList Full Stack Application`

4. **Generate Token**
   - My Account → Security → Generate Tokens
   - Name: `github-actions`
   - Type: `Project Analysis Token`

5. **Configure GitHub Secrets**
   ```bash
   SONAR_TOKEN=<your-token>
   SONAR_HOST_URL=http://your-sonarqube-server:9000
   ```

### Option 3: Using Docker Compose (Development)

Add to your `docker-compose.yml`:

```yaml
services:
  sonarqube:
    image: sonarqube:lts-community
    container_name: todoapp-sonarqube
    ports:
      - "9000:9000"
    networks:
      - todoapp-network
    volumes:
      - sonarqube_data:/opt/sonarqube/data
      - sonarqube_logs:/opt/sonarqube/logs
      - sonarqube_extensions:/opt/sonarqube/extensions
    environment:
      - SONAR_ES_BOOTSTRAP_CHECKS_DISABLE=true

volumes:
  sonarqube_data:
  sonarqube_logs:
  sonarqube_extensions:
```

Then run:
```bash
docker-compose up -d sonarqube
# Wait for startup (may take 1-2 minutes)
# Access: http://localhost:9000
```

## Running Analysis Locally

### Prerequisites
```bash
# Install SonarScanner CLI
brew install sonar-scanner  # macOS
# or download from: https://docs.sonarqube.org/latest/analyzing-source-code/scanners/sonarscanner/
```

### Run Analysis
```bash
# Make sure SonarQube server is running
sonar-scanner \
  -Dsonar.projectKey=todolist-app \
  -Dsonar.sources=. \
  -Dsonar.host.url=http://localhost:9000 \
  -Dsonar.token=<your-token>
```

Or use the configuration in `sonar-project.properties`:
```bash
sonar-scanner
```

## Understanding the Configuration

### sonar-project.properties

```properties
# Project identification
sonar.projectKey=todolist-app
sonar.projectName=TodoList Full Stack Application
sonar.projectVersion=1.0.0

# Source locations
sonar.sources=src,backend/Controllers,backend/Data,backend/DTOs,backend/Models,backend/Services
sonar.tests=src/__tests__,backend.Tests

# Coverage reports (generated by tests)
sonar.javascript.lcov.reportPaths=coverage/lcov.info
sonar.cs.opencover.reportsPaths=backend/coverage.xml

# Exclusions (node_modules, build outputs, test files)
sonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/bin/**,**/obj/**
```

## Quality Gates

SonarQube will check:

### Frontend (JavaScript/TypeScript)
- Code smells and bugs
- Security vulnerabilities
- Code coverage (if tests generate lcov.info)
- Code duplication
- Technical debt

### Backend (.NET)
- C# code quality
- Security hotspots
- Test coverage (if tests generate coverage.xml)
- Maintainability issues
- Reliability issues

## Generating Coverage Reports

### Frontend Coverage
```bash
# Run tests with coverage
npm run test:coverage

# This generates: coverage/lcov.info
```

### Backend Coverage
```bash
# Install coverage tool
dotnet tool install --global dotnet-reportgenerator-globaltool

# Run tests with coverage
cd backend.tests
dotnet test --collect:"XPlat Code Coverage" --results-directory ./TestResults

# Convert to OpenCover format
reportgenerator \
  -reports:"TestResults/*/coverage.cobertura.xml" \
  -targetdir:"../backend/coverage" \
  -reporttypes:"OpenCover"
```

## Disabling SonarQube (Current State)

The SonarQube job is currently **disabled by default** because:

1. No SonarQube server is configured
2. No `SONAR_TOKEN` and `SONAR_HOST_URL` secrets are set
3. The workflow will skip this job automatically

To permanently disable:

### Option 1: Remove from workflow
Delete the `sonarqube-analysis` job from `.github/workflows/build.yml`

### Option 2: Keep but never run
The current configuration already does this - it only runs when secrets exist.

## Troubleshooting

### Error: "Expected URL scheme 'http' or 'https'"
**Solution**: Add `sonar.host.url` to `sonar-project.properties` or set `SONAR_HOST_URL` secret

### Error: "Not authorized. Analyzing this project requires authentication"
**Solution**: Generate a project analysis token and set `SONAR_TOKEN` secret

### Error: "Project key already exists"
**Solution**: Use a unique project key or delete the existing project in SonarQube

### Analysis runs but no results appear
**Solution**: 
1. Check SonarQube server logs
2. Verify source paths in `sonar-project.properties`
3. Ensure token has correct permissions

## Next Steps

If you want to enable SonarQube:

1. Choose a SonarQube option (Cloud, self-hosted, or Docker)
2. Create project and generate token
3. Add GitHub secrets: `SONAR_TOKEN` and `SONAR_HOST_URL`
4. Push to main branch - analysis will run automatically

If you don't need code quality analysis:

- Leave it as is - the job will be skipped
- No action required

## Resources

- [SonarCloud Documentation](https://docs.sonarcloud.io/)
- [SonarQube Documentation](https://docs.sonarqube.org/latest/)
- [SonarScanner for .NET](https://docs.sonarqube.org/latest/analyzing-source-code/scanners/sonarscanner-for-dotnet/)
- [SonarScanner for JavaScript](https://docs.sonarqube.org/latest/analyzing-source-code/scanners/sonarscanner/)
